<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Guerreros de Tenochtitl√°n</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <!-- Panel izquierdo -->
        <div class="left-panel">
            <div class="title-section">
                <h1 class="game-title">
                    <span class="skull-icon">üíÄ</span>
                    GUERREROS DE<br>
                    TENOCHTITL√ÅN
                    <span class="skull-icon">üíÄ</span>
                </h1>
            </div>

            <div class="players-section">
                {% for jugador, pos, ficha in combinados %}
                <div class="player-card">
                    <div class="player-avatar" style="background-image: url('{{ url_for('static', filename='img/' + ficha) }}');"></div>
                    <div class="player-info">
                        <div class="player-name">{{ jugador }}</div>
                        <div class="player-character">Guerrero</div>
                    </div>
                    <div class="player-position">Pos:{{ pos }}</div>
                </div>
                {% endfor %}
            </div>

            <div class="dice-section">
                <h3 class="dice-title">DADOS SAGRADOS DE<br>TONATIUH</h3>
                <div class="dice-container" id="dice-values">
                    <div class="dice">-</div>
                    <div class="dice">-</div>
                </div>
            </div>

            <button class="invoke-button" id="btn-lanzar" onclick="lanzarDado()">
                <span class="skull-small">üíÄ</span>
                INVOCAR A TONATIUH
                <span class="skull-small">üíÄ</span>
            </button>

            <div class="turn-section">
                <div class="turn-icon">‚öôÔ∏è</div>
                <div class="turn-info">
                    <div class="turn-label">Turno del<br>guerrero:</div>
                    <div class="current-player">
                        <div class="current-avatar" style="background-image: url('{{ url_for('static', filename='img/' + combinados[turno][2]) }}');"></div>
                        <div class="current-name">{{ combinados[turno][0] }}<br><span class="action">Jugar</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tablero -->
        <div class="game-board">
            <div class="temple-header">
                <div class="pyramid-icon">üèõÔ∏è</div>
                <span class="temple-text">TEMPLO SAGRADO - CASILLA 100</span>
                <div class="pyramid-icon">üèõÔ∏è</div>
            </div>

            <div class="board-grid">
                <!-- Se genera con JS -->
            </div>

            <div class="journey-footer">
                <div class="aztec-symbol">üåÄ</div>
                <span class="journey-text">INICIO DEL VIAJE - CASILLA 1</span>
                <div class="aztec-symbol">üåÄ</div>
            </div>
        </div>
    </div>

    <!-- JavaScript embebido -->
    <script>
        let miTurno = false;

        function actualizarJuego() {
            fetch('/estado')
                .then(res => res.json())
                .then(data => {
                    document.querySelector('.current-name').innerHTML =
                        `${data.jugadores[data.turno]}<br><span class="action">Jugar</span>`;
                    miTurno = localStorage.getItem("nombre") === data.jugadores[data.turno];
                    document.getElementById("btn-lanzar").disabled = !miTurno;
                    construirTablero(data);
                });
        }

        function lanzarDado() {
            fetch('/lanzar')
                .then(res => res.json())
                .then(data => {
                    const dados = document.querySelectorAll(".dice");
                    dados[0].innerText = data.dado1;
                    dados[1].innerText = data.dado2;

                    if (data.ganador) {
                        alert(`¬°${data.ganador} ha ganado!`);
                        window.location.href = "/reiniciar";
                    } else {
                        actualizarJuego();
                    }
                });
        }

        function construirTablero(data) {
            const grid = document.querySelector(".board-grid");
            grid.innerHTML = "";

            for (let fila = 9; fila >= 0; fila--) {
                const row = document.createElement("div");
                row.className = "board-row";

                for (let col = 0; col < 10; col++) {
                    let i;
                    if ((9 - fila) % 2 === 0) {
                        i = (9 - fila) * 10 + (9 - col) + 1;
                    } else {
                        i = (9 - fila) * 10 + col + 1;
                    }

                    let clase = "board-cell";
                    if (data.serpientes[i]) clase += " snake";
                    if (data.escaleras[i]) clase += " ladder";
                    if (data.posiciones[data.turno] === i) clase += " actual";
                    if (i === 1) clase += " start";
                    if (i === 100) clase += " goal";

                    const cell = document.createElement("div");
                    cell.className = clase;
                    cell.dataset.number = i;
                    cell.innerHTML = i;

                    if (i === 1) {
                        const inicio = document.createElement("div");
                        inicio.className = "inicio";
                        inicio.textContent = "INICIO";
                        cell.appendChild(inicio);
                    }

                    if (i === 100) {
                        const meta = document.createElement("div");
                        meta.className = "meta";
                        meta.textContent = "META";
                        cell.appendChild(meta);
                    }

                    if (data.serpientes[i]) {
                        const img = document.createElement("img");
                        img.src = "/static/img/serpiente.png";
                        img.style = "position:absolute;top:5px;left:5px;width:30px;";
                        cell.appendChild(img);
                    }

                    if (data.escaleras[i]) {
                        const img = document.createElement("img");
                        img.src = "/static/img/escalera.png";
                        img.style = "position:absolute;bottom:5px;right:5px;width:30px;";
                        cell.appendChild(img);
                    }

                    const jugadoresEnCasilla = data.jugadores
                        .map((nombre, idx) => ({
                            nombre,
                            pos: data.posiciones[idx],
                            ficha: data.fichas[idx]
                        }))
                        .filter(j => j.pos === i);

                    if (jugadoresEnCasilla.length > 0) {
                        const divJugadores = document.createElement("div");
                        divJugadores.className = "jugador";
                        jugadoresEnCasilla.forEach(j => {
                            const img = document.createElement("img");
                            img.src = `/static/img/${j.ficha}`;
                            img.width = 25;
                            img.style.transition = "transform 0.4s ease";
                            img.style.transform = "scale(1.2)";
                            divJugadores.appendChild(img);
                        });
                        cell.appendChild(divJugadores);
                    }

                    row.appendChild(cell);
                }

                grid.appendChild(row);
            }
        }

        setInterval(actualizarJuego, 2000);
        document.addEventListener("DOMContentLoaded", actualizarJuego);
    </script>
</body>
</html>
